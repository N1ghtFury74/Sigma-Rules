title: CNC-E-2726320-144-Esentutl UNC-to-UNC File Copy (Process Creation)
id: 0c9f0c0e-3a2a-4f2e-9a44-2726320144aa
status: test
description: |
  Detects Esentutl.exe used to copy a file from one UNC path to another using the
  "/y <source> /d <dest> [/o]" pattern. Adversaries can abuse this LOLBIN to move or
  stage payloads over SMB/WebDAV shares without bespoke tooling.
author: Mohamed Hanii
date: 2025-10-02
references:
  - https://lolbas-project.github.io/lolbas/Binaries/Esentutl/
tags:
  - attack.t1105
  - attack.command_and_control

logsource:
  product: windows
  category: process_creation

detection:
  # -------- Sysmon (Event ID 1) --------
  sel_sysmon_eid1:
    EventID: 1
  sel_sysmon_image:
    Image|endswith: '\esentutl.exe'
  sel_sysmon_ofn:
    OriginalFileName: 'ESENTUTL.EXE'
  sel_sysmon_cli_core:
    CommandLine|contains|all:
      - '/y'
      - '/d'
      - '\\\\'       # UNC indicator
      - '\DavWWWRoot' 
      - '@SSL'
  # Optional optimization switch often seen in examples
  sel_sysmon_cli_o:
    CommandLine|contains: '/o'

  # -------- Windows Security (Event ID 4688) --------
  sel_4688_eid:
    EventID: 4688
  sel_4688_proc:
    NewProcessName|endswith: '\esentutl.exe'
  sel_4688_cli_core:
    ProcessCommandLine|contains|all:
      - '/y'
      - '/d'
      - '\\\\'
      - '\DavWWWRoot' 
      - '@SSL'
  sel_4688_cli_o:
    ProcessCommandLine|contains: '/o'

  # Fire when esentutl.exe runs with /y and /d against UNC paths (with or without /o)
  condition: 
    ( sel_sysmon_eid1 and (sel_sysmon_image or sel_sysmon_ofn) and sel_sysmon_cli_core ) 
    or 
    ( sel_4688_eid and sel_4688_proc and sel_4688_cli_core )

falsepositives:
  - Legitimate use of Esentutl for administrative file operations, database maintenance, or scripted copies between internal shares.
  - Software distribution or backup workflows that copy files across SMB/WebDAV paths.
level: high
