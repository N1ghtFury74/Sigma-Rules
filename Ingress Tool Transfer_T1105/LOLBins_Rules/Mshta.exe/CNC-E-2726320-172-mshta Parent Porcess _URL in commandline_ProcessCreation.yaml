title: CNC-E-2726320-172-mshta Parent ≠ explorer.exe + URL in CLI (Process Creation)
id: 9f3d7b2e-1c2a-4f62-9b71-2726320172aa
status: test
description: |
  Detects mshta.exe launched by a parent process other than explorer.exe AND with a URL
  in the command line (http/https/ftp). mshta is a common LOLBIN for remote execution
  and can download to INetCache when given a URL—often used for script-proxying or
  ingress tool transfer (T1105 / T1218.005).
author: Mohamed Hanii
date: 2025-10-07
references:
  - https://lolbas-project.github.io/lolbas/Binaries/Mshta/
  - https://redcanary.com/threat-detection-report/trends/initial-access/
  - https://redcanary.com/threat-detection-report/techniques/mshta/
  - https://www.elastic.co/docs/reference/security/prebuilt-rules/rules/windows/defense_evasion_mshta_beacon
  - https://help.fortinet.com/fsiem/Public_Resource_Access/7_2_3/rules/PH_RULE_Remotely_Hosted_HTA_File_Executed_Via_Mshta_EXE.htm

tags:
  - attack.t1105
  - attack.command_and_control
  - attack.t1218.005

logsource:
  product: windows
  category: process_creation

detection:
  # ---- Sysmon (EID 1) ----
  sel_sysmon_base:
    EventID: 1
  sel_sysmon_mshta:
    Image|endswith: '\mshta.exe'
  sel_sysmon_parent_not_explorer:
    ParentImage|endswith: 
      - '\explorer.exe'
      - 'TeamViewer.exe'
      - 'amazonAssistantService.exe'
  sel_sysmon_url:
    CommandLine|contains:
      - 'http://'
      - 'https://'
      - 'ftp://'

  # ---- Windows Security (EID 4688) ----
  sel_4688_base:
    EventID: 4688
  sel_4688_mshta:
    NewProcessName|endswith: '\mshta.exe'
  sel_4688_parent_not_explorer:
    CreatorProcessName|endswith: 
      - '\explorer.exe'
      - 'TeamViewer.exe'
      - 'amazonAssistantService.exe'
  sel_4688_url:
    ProcessCommandLine|contains:
      - 'http://'
      - 'https://'
      - 'ftp://'

  # Fire when: mshta + parent is NOT explorer.exe + URL indicator
  condition: 
    ( sel_sysmon_base and sel_sysmon_mshta and (not sel_sysmon_parent_not_explorer) and sel_sysmon_url ) or 
    ( sel_4688_base and sel_4688_mshta and (not sel_4688_parent_not_explorer) and sel_4688_url )

falsepositives:
  - Admin or software automation launching mshta with remote content (internal update scripts, deployment tools).
  - Mshta.exe may be triggered by legitimate software updates or installations, such as those from Microsoft Configuration Management. To handle this, add exceptions for processes with parent names like Microsoft.ConfigurationManagement.exe.
  - Tuning: allow-list known IT scripts/paths , applications and approved internal hosts; investigate internet destinations and unexpected launchers.
level: high
